# Boxv2

## Установка 

1. Установка
   
    а) Из пакета.
   
    Скачать пакет отсюда: https://gitlab.ccsteam.ru/rnd/box-v2/-/packages
   
    Установить скачанный пакет
    ```bash
    pip install --user boxv2-0.2.1-py3-none-any.whl
    ```
   
    б) Из исходников.
   
    Склонировать репозиторий с исходниками
    ```bash
    git clone https://gitlab.ccsteam.ru/rnd/box-v2.git
    ```
    Собрать пакет и установить его
    ```bash
    cd box-v2
    poetry build
    pip install --user dist/boxv2-0.2.1-py3-none-any.whl
    ```

2. Создание проекта из шаблона
   
    ```bash
    boxv2 -v -t http://path/to/template -p plugin1 -p plugin2 bot_project_name
    cd bot_project_name
    ```
   
3. Установка зависимостей

    ```bash
    poetry install
    ```
    Важно: библиотека boxv2 в созданном проекте автоматически обновится из гита до
    последней версии. Если такое поведение нежелательно, то необходимо указать
    в файле pyproject.toml конкретную версию 
    ```
    boxv2 = { git = "https://gitlab.ccsteam.ru/rnd/box-v2.git", tag = "0.2.1"}
    ```    

4. Обновление
   
    Для обновления библиотеки в проекте:
    ```bash
    poetry update
    ```
   
    Для обновления шаблона для новых проектов - повторить операции из пункта 1.


5. Настройки бота
    
    Настройки бота находятся в файле `app/settings.py` и представляют собой класс
    унаследованный от `pydantic.BaseSettings`. При необходимости можно изменить место
    расположения настроек с помощью переменной окружения `APP_SETTINGS` задав её
    значением строку вида `app.settings:AppSettings`, где до двоеточия указывается
    модуль, а после двоеточия объект внутри модуля.
   
    Функциональность бота можно расширять при помощи плагинов. Список включеных плагинов
    задаётся настройкой `PLUGINS`, которая является списком строк в описанном выше
    формате. Имя класса `Plugin` можно не указывать.
    Плагины вкючённые в библиотеку:
   
    | Путь                             | Описание
    -----------------------------------|:-----------------------------------
    | boxv2.plugins.logger             | расширенне логирование (Loguru)
    | boxv2.plugins.tortoise           | БД (PostgreSQL)
    | boxv2.plugins.redis              | Redis
    | boxv2.plugins.forbid_ext_cts     | запрет внешних CTS
    | boxv2.plugins.sentry             | мониторинг ошибок (Sentry)
    | boxv2.plugins.prometheus         | сбор метрик (Prometheus)

    Каждый из плагинов может требовать наличия определённых настроек. В этом случае
    необходимо добавить соответствующую настройку в класс AppSettings
   
    Список коллекторов хэндлеров комманд задаётся в настроке `COLLECTORS` в таком же
    формате как и список плагинов.
   